<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js"></script>
    <link rel="stylesheet" href="/css/index.css" />
  </head>
  <body>
    <div class="container">
      <div class="row g-3 row-cols-1">
        <div class="col">
          <h1 class="mt-3 fs-2">Installation</h1>
          <p>
            Please enter your email and password to install the application.
          </p>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-header d-flex gap-3 align-items-center">
              <i class="ti ti-brand-docker fs-1"></i>
              <h5 class="card-title m-0">Build docker</h5>
              <button class="ms-auto btn btn-primary" id="buildDocker">
                <i class="ti ti-player-play"></i> Build
              </button>
            </div>
            <div class="card-body">
              <ul class="list-group list-group-flush" id="dockerStats"></ul>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card">
            <div class="card-header d-flex gap-3 align-items-center">
              <i class="ti ti-cube fs-1"></i>
              <h5 class="card-title m-0">Start containers</h5>
              <button class="ms-auto btn btn-primary" id="startContainers">
                <i class="ti ti-player-play"></i> Start
              </button>
            </div>
            <div class="card-body">
              <ul class="list-group list-group-flush" id="containerStats"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>

    <script>
      // ------------------------------------------------
      // ------------------ Services --------------------
      // ------------------------------------------------
      const buildDockerService = async function () {
        try {
          const response = await fetch("/docker-build", { method: "POST" });

          if (!response.ok) {
            const message = await response.text();
            return Promise.reject(message);
          }

          return await response.json();
        } catch (error) {
          return Promise.reject(error.message);
        }
      };

      const startContainersService = async function () {
        try {
          const response = await fetch("/containers-start", { method: "POST" });

          if (!response.ok) {
            const message = await response.text();
            return Promise.reject(message);
          }

          return await response.json();
        } catch (error) {
          return Promise.reject(error.message);
        }
      };

      // ------------------------------------------------
      // ----------------- Event Listeners --------------
      // ------------------------------------------------
      const buildDockerBtn = document.querySelector("#buildDocker");
      buildDockerBtn.addEventListener("click", async () => {
        try {
          buildDockerBtn.disabled = true;
          buildDockerBtn.innerHTML = `<i class="ti ti-loader"></i> Building...`;
          await buildDockerService();
          buildDockerBtn.innerHTML = `<i class="ti ti-circle-check"></i> Done`;
        } catch (error) {
          buildDockerBtn.disabled = false;
          buildDockerBtn.classList.remove("btn-primary");
          buildDockerBtn.classList.add("btn-danger");
          buildDockerBtn.innerHTML = `<i class="ti ti-circle-x"></i> Rerun`;
          document.querySelector(
            "#dockerStats"
          ).innerHTML = `<li class="list-group-item text-danger small p-1">${error}</li>`;
        }
      });

      const startContainersBtn = document.querySelector("#startContainers");
      startContainersBtn.addEventListener("click", async () => {
        try {
          startContainersBtn.disabled = true;
          startContainersBtn.innerHTML = `<i class="ti ti-loader"></i> Starting...`;
          await startContainersService();
          startContainersBtn.innerHTML = `<i class="ti ti-circle-check"></i> Done`;
        } catch (error) {
          startContainersBtn.disabled = false;
          startContainersBtn.classList.remove("btn-primary");
          startContainersBtn.classList.add("btn-danger");
          startContainersBtn.innerHTML = `<i class="ti ti-circle-x"></i> Rerun`;
          document.querySelector(
            "#containerStats"
          ).innerHTML = `<li class="list-group-item text-danger small p-1">${error}</li>`;
        }
      });

      // ------------------------------------------------
      // ----------------- Socket.io ---------------------
      // ------------------------------------------------
      const socket = io();
      let logsDockerBuild = "";
      let logsDockerStart = "";

      socket.on("docker-build", (log) => {
        logsDockerBuild += log;
        document.querySelector("#dockerStats").innerHTML = logsDockerBuild
          .split("\n")
          .filter((line) => line)
          .map((line) => {
            return `<li class="list-group-item small p-1">${line}</li>`;
          })
          .join("");
      });

      socket.on("containers-start", (log) => {
        logsDockerStart += log;
        document.querySelector("#containerStats").innerHTML = logsDockerStart
          .split("\n")
          .filter((line) => line)
          .map((line) => {
            return `<li class="list-group-item small p-1">${line}</li>`;
          })
          .join("");
      });
    </script>
  </body>
</html>
